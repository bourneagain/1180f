<!DOCTYPE html>

<html>
<head>
<title>Lec03: Integer Overflow and Undefined Behavior</title>
<meta charset="utf-8"/>
<meta content="ie=edge" http-equiv="x-ua-compatible"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="../shower/styles/ribbon.css" rel="stylesheet"/>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
{ position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
{ content: attr(title);
  position: relative; left: -1em; text-align: right; vertical-align: baseline;
  border: none; pointer-events: all; display: inline-block;
  -webkit-touch-callout: none; -webkit-user-select: none;
  -khtml-user-select: none; -moz-user-select: none;
  -ms-user-select: none; user-select: none;
  padding: 0 4px; width: 4em;
  color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
{  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<style>
section pre code {
  line-height: 1.4 !important;
  font-size: 20px !important;
}
.compact code {
  line-height: 1.4 !important;
  font-size: 16px !important;
}
ul.compact {
  line-height: 1.5 !important;
  font-size: 20px !important;
}
.writeup {
    font-size: 20px !important;
}
a.sourceLine { background: none !important; }
section.region { display: none !important; }
pre.numberSource { margin-left: 2em; }
div.sourceCode { overflow: hidden; }
a.sourceLine::before { text-decoration: none; }

</style>
<script src="../shower/js/jquery-2.2.0.min.js"></script>
</head>
<body class="shower list">
<header class="caption">
<h1>Security vulnerabilities and their mitigation in native code</h1>
<p>Taesoo Kim</p>
</header>
<header class="caption">
</header>
<section class="slide" id="cover">
<br/><br/><br/><br/>
<h2>Lec03: Integer Overflow and Undefined Behavior</h2>
<p> Taesoo Kim</p>
<style>
 #cover h2 {
   /* margin:180px 0 0; */
   color: #666;
   text-align:center;
   font-size: 50px;
   font-weight: bold;
   margin-bottom: 1.5em;
 }
 #cover p {
   margin:30px 0 0;
   text-align:center;
   font-style:italic;
   font-size:40px;
 }
 </style>
</section>

<section class="slide level1" id="goals-and-lessons"><div>
<h1>Goals and Lessons</h1>
<ul>
<li>Learn about two classes of vulnerabilities
<ol type="1">
<li>Integer overflow</li>
<li>Undefined behavior</li>
</ol></li>
<li>Understand their security implications</li>
<li>Understand best security practices</li>
<li>Learn them from the real-world examples (Android, Linux, etc)</li>
</ul>
</div></section>
<section class="slide level1" id="cs101-integer-representation"><div>
<h1>CS101: Integer Representation</h1>
<p style="text-align:center;margin:0"><img src="img/odometer.jpg" style="width:55%"/></p>
<p>Ref. <a class="uri" href="https://en.wikipedia.org/wiki/Integer_overflow">https://en.wikipedia.org/wiki/Integer_overflow</a></p>
</div></section>
<section class="slide level1" id="cs101-twos-complement-representation"><div>
<h1>CS101: Two’s Complement Representation</h1>
<p style="text-align:center;margin:0"><img src="img/two.png" style="width:70%"/></p>
<pre><code>e.g., in x86 (32-bit, 4-byte):
    - 0x00000000 -&gt;  0
    - 0xffffffff -&gt; -1
    - 0x7fffffff -&gt;  2147483648 (INT_MAX)
    - 0x80000000 -&gt; -2147483649 (INT_MIN)</code></pre>
<p>Ref. <a class="uri" href="https://en.wikipedia.org/wiki/Two's_complement">https://en.wikipedia.org/wiki/Two's_complement</a></p>
</div></section>
<section class="slide level1" id="arithmetic-with-twos-complements"><div>
<h1>Arithmetic with Two’s Complements</h1>
<ul>
<li>One instruction works for <strong>both</strong> sign/unsigned integers (i.e., add, sub, mul)
<ul>
<li>e.g., add reg1, reg2 (not distinguishing signedness of reg1/2)</li>
</ul></li>
<li>Properties:
<ul>
<li>Non-symmetric representation of range, so single 0</li>
<li>MSB represents signedness: 1 means negative, 0 means positive</li>
</ul></li>
</ul>
<pre><code>    0x00000001 + 0x00000002 = 0x00000003 ( 1 + 2 = 3)
    0xffffffff + 0x00000002 = 0x00000001 (-1 + 2 = 1)
    0xffffffff + 0xfffffffe = 0xfffffffd (-1 +-2 =-3)

    range(signe integer) = [-2^31-1, 2^31] = [-2147483649, 2147483648]
    range(unsigned integer) = [0, 2^32-1] = [0, 4294967295]</code></pre>
</div></section>
<section class="slide level1" id="question"><div>
<h1>Question!</h1>
<ul>
<li>Then, how to interpret the arithmetic result?</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode asm"><code class="sourceCode fasm"><a class="sourceLine" id="cb3-1" title="1">    <span class="co">; 0xffffffff + 0xfffffffe = 0xfffffffd (-1 +-2 =-3)</span></a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="bu">mov</span> <span class="kw">eax</span>, <span class="bn">0xffffffff</span>   <span class="co">; eax = 0xffffffff</span></a>
<a class="sourceLine" id="cb3-4" title="4">    <span class="bu">mov</span> <span class="kw">ebx</span>, <span class="bn">0xfffffffd</span>   <span class="co">; ebx = 0xfffffffe</span></a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="bu">add</span> <span class="kw">eax</span>, <span class="kw">ebx</span>          <span class="co">; eax = 0xfffffffd</span></a>
<a class="sourceLine" id="cb3-6" title="6">    <span class="co">; eax = 0xfffffffd</span></a>
<a class="sourceLine" id="cb3-7" title="7">    <span class="co">; 1) is it -3?</span></a>
<a class="sourceLine" id="cb3-8" title="8">    <span class="co">; 2) is it 4294967293 (== 0xfffffffd)?</span></a></code></pre></div>
</div></section>
<section class="slide level1" id="idea-using-status-flags-erflags"><div>
<h1>Idea: Using Status Flags (E/RFLAGS)</h1>
<ul>
<li>CF: overflow of unsigned arithmetic operations</li>
<li>OF: overflow of signed arithmetic operations</li>
</ul>
<pre><code>  0x00000001 + 0x00000002 = 0x00000003 ( 1 + 2 = 3)
    -&gt; CF: 0   OF: 0    SF: 0
  0xffffffff + 0x00000002 = 0x00000001 (-1 + 2 = 1)
    -&gt; CF: 1   OF: 0    SF: 0
  0x80000000 + 0xffffffff = 0x7fffffff (-2147483649 + -1 =  2147483648)
    -&gt; CF: 1   OF: 1    SF: 0
  0x7fffffff + 0x00000001 = 0x80000000 ( 2147483648 +  1 = -2147483649)
    -&gt; CF: 0   OF: 1    SF: 1</code></pre>
</div></section>
<section class="slide level1" id="cs-integer-representation"><div>
<h1>C’s Integer Representation</h1>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb5-1" title="1">                        x86 (32b)     x86_64 (64b)</a>
<a class="sourceLine" id="cb5-2" title="2">    <span class="dt">char</span>                : <span class="dv">1</span> bytes       <span class="dv">1</span> bytes</a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="dt">unsigned</span> <span class="dt">char</span>       : <span class="dv">1</span> bytes       <span class="dv">1</span> bytes</a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="dt">short</span>               : <span class="dv">2</span> bytes       <span class="dv">2</span> bytes</a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="dt">unsigned</span> <span class="dt">short</span>      : <span class="dv">2</span> bytes       <span class="dv">2</span> bytes</a>
<a class="sourceLine" id="cb5-6" title="6">    <span class="dt">int</span>                 : <span class="dv">4</span> bytes       <span class="dv">4</span> bytes</a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="dt">unsigned</span> <span class="dt">int</span>        : <span class="dv">4</span> bytes       <span class="dv">4</span> bytes</a>
<a class="sourceLine" id="cb5-8" title="8">(*) <span class="dt">long</span>                : <span class="dv">4</span> bytes       <span class="dv">8</span> bytes</a>
<a class="sourceLine" id="cb5-9" title="9">(*) <span class="dt">unsigned</span> <span class="dt">long</span>       : <span class="dv">4</span> bytes       <span class="dv">8</span> bytes</a>
<a class="sourceLine" id="cb5-10" title="10">    <span class="dt">long</span> <span class="dt">long</span>           : <span class="dv">8</span> bytes       <span class="dv">8</span> bytes</a>
<a class="sourceLine" id="cb5-11" title="11">    <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span>  : <span class="dv">8</span> bytes       <span class="dv">8</span> bytes</a>
<a class="sourceLine" id="cb5-12" title="12">(*) <span class="dt">size_t</span>              : <span class="dv">4</span> bytes       <span class="dv">8</span> bytes</a>
<a class="sourceLine" id="cb5-13" title="13">(*) <span class="dt">ssize_t</span>             : <span class="dv">4</span> bytes       <span class="dv">8</span> bytes</a>
<a class="sourceLine" id="cb5-14" title="14">(*) <span class="dt">void</span>*               : <span class="dv">4</span> bytes       <span class="dv">8</span> bytes</a></code></pre></div>
</div></section>
<section class="slide level1" id="thinking-of-cs-typeprecision-conversion"><div>
<h1>Thinking of C’s Type/Precision Conversion</h1>
<ul>
<li>Lower → higher precision</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb6-1" title="1">            <span class="dt">char</span> -&gt; <span class="dt">int</span></a>
<a class="sourceLine" id="cb6-2" title="2">     [-<span class="dv">128</span>, <span class="dv">127</span>] -&gt; [-<span class="dv">128</span>, <span class="dv">127</span>]</a>
<a class="sourceLine" id="cb6-3" title="3">    [<span class="bn">0x80</span>, <span class="bn">0x7f</span>] -&gt; [<span class="bn">0xffffff80</span>, <span class="bn">0x0000007f</span>]</a>
<a class="sourceLine" id="cb6-4" title="4">                       ------&gt; sign extended (e.g., movsx)</a>
<a class="sourceLine" id="cb6-5" title="5">                        </a>
<a class="sourceLine" id="cb6-6" title="6">   <span class="dt">unsigned</span> <span class="dt">char</span> -&gt; <span class="dt">unsigned</span> <span class="dt">int</span></a>
<a class="sourceLine" id="cb6-7" title="7">        [<span class="dv">0</span>, <span class="dv">255</span>] -&gt; [<span class="dv">0</span>, <span class="dv">255</span>]</a>
<a class="sourceLine" id="cb6-8" title="8">       [<span class="dv">0</span>, <span class="bn">0xff</span>] -&gt; [<span class="dv">0</span>, <span class="bn">0x000000ff</span>]</a>
<a class="sourceLine" id="cb6-9" title="9">                          ------&gt; zero extended (e.g., movzx)</a></code></pre></div>
</div></section>
<section class="slide level1" id="thinking-of-cs-typeprecision-conversion-1"><div>
<h1>Thinking of C’s Type/Precision Conversion</h1>
<ul>
<li>Higher → lower precision (what’s correct mappings?)</li>
<li>Mathematically complex, but architecturally simple (truncation!)</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb7-1" title="1">                      <span class="dt">int</span> -&gt; <span class="dt">char</span></a>
<a class="sourceLine" id="cb7-2" title="2">[-<span class="dv">2147483649</span>, <span class="dv">2147483648</span>] -&gt; [-<span class="dv">128</span>, <span class="dv">127</span>]</a>
<a class="sourceLine" id="cb7-3" title="3"> [<span class="bn">0x80000000</span>, <span class="bn">0x7fffffff</span>] -&gt; [<span class="bn">0x80</span>, <span class="bn">0x7f</span>]</a>
<a class="sourceLine" id="cb7-4" title="4"></a>
<a class="sourceLine" id="cb7-5" title="5">            <span class="dt">unsigned</span> <span class="dt">int</span> -&gt; <span class="dt">unsigned</span> <span class="dt">char</span></a>
<a class="sourceLine" id="cb7-6" title="6">         [<span class="dv">0</span>, <span class="dv">4294967295</span>] -&gt; [<span class="dv">0</span>, <span class="dv">255</span>]</a>
<a class="sourceLine" id="cb7-7" title="7">         [<span class="dv">0</span>, <span class="bn">0xffffffff</span>] -&gt; [<span class="dv">0</span>, <span class="bn">0xff</span>]</a>
<a class="sourceLine" id="cb7-8" title="8"></a>
<a class="sourceLine" id="cb7-9" title="9">        both simply, eax -&gt; al  (by processor)</a></code></pre></div>
</div></section>
<section class="slide level1" id="example-of-precision-conversion"><div>
<h1>Example of Precision Conversion</h1>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb8-1" title="1">$ cd lec03-intovfl/intovfl</a>
<a class="sourceLine" id="cb8-2" title="2">$ ./intovfl2</a>
<a class="sourceLine" id="cb8-3" title="3"><span class="bn">0x7fffffff</span> -&gt;</a>
<a class="sourceLine" id="cb8-4" title="4">  (<span class="dt">unsigned</span> <span class="dt">int</span>)(<span class="dt">unsigned</span> <span class="dt">char</span>): 000000ff</a>
<a class="sourceLine" id="cb8-5" title="5">  ; mov eax, <span class="bn">0x7fffffff</span></a>
<a class="sourceLine" id="cb8-6" title="6">  ; movzx eax, al</a>
<a class="sourceLine" id="cb8-7" title="7">  </a>
<a class="sourceLine" id="cb8-8" title="8">  (<span class="dt">unsigned</span> <span class="dt">int</span>)(<span class="dt">char</span>)         : ffffffff</a>
<a class="sourceLine" id="cb8-9" title="9">  ; mov eax, <span class="bn">0x7fffffff</span></a>
<a class="sourceLine" id="cb8-10" title="10">  ; movsx eax, al</a></code></pre></div>
</div></section>
<section class="slide level1" id="question-1"><div>
<h1>Question?</h1>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb9-1" title="1"><span class="dt">char</span> c1 = <span class="dv">100</span>;</a>
<a class="sourceLine" id="cb9-2" title="2"><span class="dt">char</span> c2 = <span class="dv">3</span>;</a>
<a class="sourceLine" id="cb9-3" title="3"><span class="dt">char</span> c3 = <span class="dv">4</span>;</a>
<a class="sourceLine" id="cb9-4" title="4"></a>
<a class="sourceLine" id="cb9-5" title="5">c1 = c1 * c2 / c3;</a>
<a class="sourceLine" id="cb9-6" title="6">     ------- Q1?</a>
<a class="sourceLine" id="cb9-7" title="7">     ------------ Q2?</a>
<a class="sourceLine" id="cb9-8" title="8"></a>
<a class="sourceLine" id="cb9-9" title="9">  <span class="dv">1</span>) <span class="dv">300</span> / <span class="dv">4</span> = <span class="dv">75</span></a>
<a class="sourceLine" id="cb9-10" title="10">  <span class="dv">2</span>) <span class="dv">300</span> (<span class="bn">0x12c</span>, which is &gt; <span class="dv">8</span> bytes) -&gt; <span class="bn">0x2c</span> / <span class="dv">4</span> = <span class="dv">11</span></a></code></pre></div>
</div></section>
<section class="slide level1" id="basic-concept-integer-promotion"><div>
<h1>Basic Concept: Integer Promotion</h1>
<ul>
<li>Before any arithmetic operations,</li>
<li>All integer types whose size is smaller than sizeof(int):
<ol type="1">
<li>Promote to int (if int can represent the whole range)</li>
<li>Promote to unsigned int (if not)</li>
</ol></li>
</ul>
</div></section>
<section class="slide level1" id="example-charunsigned-char-addition"><div>
<h1>Example: char/unsigned char Addition</h1>
<ul>
<li>Promote to int (if int can represent the whole range)</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb10-1" title="1">  <span class="co">// by rule 1. -&gt; (1)</span></a>
<a class="sourceLine" id="cb10-2" title="2">  <span class="dt">char</span> sc = SCHAR_MAX;</a>
<a class="sourceLine" id="cb10-3" title="3">  <span class="dt">unsigned</span> <span class="dt">char</span> uc = UCHAR_MAX;</a>
<a class="sourceLine" id="cb10-4" title="4">  </a>
<a class="sourceLine" id="cb10-5" title="5">  <span class="dt">long</span> <span class="dt">long</span> sll = sc + uc;</a>
<a class="sourceLine" id="cb10-6" title="6"></a>
<a class="sourceLine" id="cb10-7" title="7">      <span class="dv">1</span>) (<span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span>)((<span class="dt">int</span>)sc + (<span class="dt">int</span>)uc)?</a>
<a class="sourceLine" id="cb10-8" title="8">      <span class="dv">2</span>) (<span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span>)sc + (<span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span>)uc?</a></code></pre></div>
</div></section>
<section class="slide level1" id="example-intunsigned-int-comparison"><div>
<h1>Example: int/unsigned int Comparison</h1>
<ul>
<li>Promote to unsigned int (if not)</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb11-1" title="1">  <span class="co">// by rule 2. -&gt; (2)</span></a>
<a class="sourceLine" id="cb11-2" title="2">  <span class="dt">int</span> si = <span class="dv">-1</span>;</a>
<a class="sourceLine" id="cb11-3" title="3">  <span class="dt">unsigned</span> <span class="dt">int</span> ui = <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb11-4" title="4">  </a>
<a class="sourceLine" id="cb11-5" title="5">  printf(<span class="st">"%d</span><span class="sc">\n</span><span class="st">"</span>, (<span class="dt">int</span>)(si &lt; ui));</a>
<a class="sourceLine" id="cb11-6" title="6">               <span class="dv">1</span>) ui promotes to <span class="dt">int</span></a>
<a class="sourceLine" id="cb11-7" title="7">                  = <span class="dv">-1</span> &lt; <span class="dv">1</span></a>
<a class="sourceLine" id="cb11-8" title="8">                  = <span class="dv">1</span></a>
<a class="sourceLine" id="cb11-9" title="9">               <span class="dv">2</span>) si promotes to <span class="dt">unsigned</span> <span class="dt">int</span></a>
<a class="sourceLine" id="cb11-10" title="10">                  = <span class="bn">0xffffffff</span> &lt; <span class="dv">1</span></a>
<a class="sourceLine" id="cb11-11" title="11">                  = <span class="dv">0</span></a></code></pre></div>
</div></section>
<section class="slide level1" id="remark-undefined-behaviors"><div>
<h1>Remark: Undefined Behaviors</h1>
<ul>
<li>Overflow of <strong>unsigned integers</strong> are <strong>well-defined</strong> (i.e., wrapping)</li>
<li>Overflow of <strong>signed</strong> integers are <strong>undefined</strong>
<ul>
<li>But well-defined to the processor (i.e., just wrapping in x86)</li>
<li>Optimization takes advantages of this, making it hard to understand</li>
</ul></li>
</ul>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb12-1" title="1"><span class="fl">1.</span> (in x86_64) what does the expression  <span class="dv">1</span> &gt; <span class="dv">0</span>  evaluate to?</a>
<a class="sourceLine" id="cb12-2" title="2">    (a) <span class="dv">0</span>   (b) <span class="dv">1</span>   (c) NaN   (d) <span class="dv">-1</span>    (e) undefined</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-1"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb13-1" title="1"><span class="fl">1.</span> (in x86_64) what does the expression  <span class="dv">1</span> &gt; <span class="dv">0</span>  evaluate to?</a>
<a class="sourceLine" id="cb13-2" title="2">    (a) <span class="dv">0</span>   (b) <span class="dv">1</span>   (c) NaN   (d) <span class="dv">-1</span>    (e) undefined</a>
<a class="sourceLine" id="cb13-3" title="3"></a>
<a class="sourceLine" id="cb13-4" title="4">&gt;&gt; (a)</a>
<a class="sourceLine" id="cb13-5" title="5"> </a>
<a class="sourceLine" id="cb13-6" title="6">   (<span class="dt">int</span>) <span class="dv">1</span> &gt; (<span class="dt">int</span>) <span class="dv">0</span></a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-2"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb14-1" title="1"><span class="fl">2.</span> (<span class="dt">unsigned</span> <span class="dt">short</span>)<span class="dv">1</span> &gt; <span class="dv">-1</span>?</a>
<a class="sourceLine" id="cb14-2" title="2">    (a) <span class="dv">1</span>   (b) <span class="dv">0</span>   (c) <span class="dv">-1</span>    (d) undefined</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-3"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb15-1" title="1"><span class="fl">2.</span> (<span class="dt">unsigned</span> <span class="dt">short</span>)<span class="dv">1</span> &gt; <span class="dv">-1</span>?</a>
<a class="sourceLine" id="cb15-2" title="2">    (a) <span class="dv">1</span>   (b) <span class="dv">0</span>   (c) <span class="dv">-1</span>    (d) undefined</a>
<a class="sourceLine" id="cb15-3" title="3"></a>
<a class="sourceLine" id="cb15-4" title="4">&gt;&gt; (a)</a>
<a class="sourceLine" id="cb15-5" title="5"></a>
<a class="sourceLine" id="cb15-6" title="6">   <span class="dt">unsigned</span> <span class="dt">short</span> can be represented by <span class="dt">int</span></a>
<a class="sourceLine" id="cb15-7" title="7">   (<span class="dt">int</span>)(<span class="dt">unsigned</span> <span class="dt">short</span>)<span class="dv">1</span> &gt; (<span class="dt">int</span>)-<span class="dv">1</span></a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-4"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb16-1" title="1"><span class="fl">3.</span> -1U &gt; <span class="dv">0</span>?</a>
<a class="sourceLine" id="cb16-2" title="2">    (a) <span class="dv">1</span>   (b) <span class="dv">0</span>   (c) <span class="dv">-1</span>    (d) undefined</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-5"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb17-1" title="1"><span class="fl">3.</span> -1U &gt; <span class="dv">0</span>?</a>
<a class="sourceLine" id="cb17-2" title="2">    (a) <span class="dv">1</span>   (b) <span class="dv">0</span>   (c) <span class="dv">-1</span>    (d) undefined</a>
<a class="sourceLine" id="cb17-3" title="3"></a>
<a class="sourceLine" id="cb17-4" title="4">&gt;&gt; (a)</a>
<a class="sourceLine" id="cb17-5" title="5">   </a>
<a class="sourceLine" id="cb17-6" title="6">   <span class="dt">unsigned</span> <span class="dt">int</span> can't be represented by <span class="dt">int</span>,</a>
<a class="sourceLine" id="cb17-7" title="7">     so promote to <span class="dt">unsigned</span> <span class="dt">int</span></a>
<a class="sourceLine" id="cb17-8" title="8">   (<span class="dt">unsigned</span> <span class="dt">int</span>)(-1U) = <span class="bn">0xffffffff</span> &gt; <span class="dv">0</span></a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-6"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb18"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb18-1" title="1"><span class="fl">4.</span> UINT_MAX + <span class="dv">1</span>?</a>
<a class="sourceLine" id="cb18-2" title="2">    (a) <span class="dv">0</span>   (b) <span class="dv">1</span>   (c) INT_MAX   (d) UINT_MAX  (e) undefined</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-7"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb19"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb19-1" title="1"><span class="fl">4.</span> UINT_MAX + <span class="dv">1</span>?</a>
<a class="sourceLine" id="cb19-2" title="2">    (a) <span class="dv">0</span>   (b) <span class="dv">1</span>   (c) INT_MAX   (d) UINT_MAX  (e) undefined</a>
<a class="sourceLine" id="cb19-3" title="3"></a>
<a class="sourceLine" id="cb19-4" title="4">&gt;&gt; (a)</a>
<a class="sourceLine" id="cb19-5" title="5"></a>
<a class="sourceLine" id="cb19-6" title="6">   simply wrap around: <span class="bn">0xffffffff</span> + <span class="dv">1</span> = <span class="dv">0</span> (CR = <span class="dv">1</span>)</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-8"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb20"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb20-1" title="1"><span class="fl">5.</span> abs(-<span class="dv">2147483648</span>), abs(INT_MIN) in x86_32?</a>
<a class="sourceLine" id="cb20-2" title="2">    (a) <span class="dv">0</span>  (b) &lt; <span class="dv">0</span>  (c) &gt; <span class="dv">0</span>  (d) NaN</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-9"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb21-1" title="1"><span class="fl">5.</span> abs(-<span class="dv">2147483648</span>), abs(INT_MIN) in x86_32?</a>
<a class="sourceLine" id="cb21-2" title="2">    (a) <span class="dv">0</span>  (b) &lt; <span class="dv">0</span>  (c) &gt; <span class="dv">0</span>  (d) NaN</a>
<a class="sourceLine" id="cb21-3" title="3"></a>
<a class="sourceLine" id="cb21-4" title="4">&gt;&gt; (b)</a>
<a class="sourceLine" id="cb21-5" title="5">   Undefined, but the way the processor works:</a>
<a class="sourceLine" id="cb21-6" title="6"></a>
<a class="sourceLine" id="cb21-7" title="7">   <span class="dt">int</span> abs (<span class="dt">int</span> i) {</a>
<a class="sourceLine" id="cb21-8" title="8">     <span class="cf">return</span> i &lt; <span class="dv">0</span> ? -i : i;</a>
<a class="sourceLine" id="cb21-9" title="9">   }</a>
<a class="sourceLine" id="cb21-10" title="10">  </a>
<a class="sourceLine" id="cb21-11" title="11">   Q. What about in x86 (<span class="dv">64</span>-bit)?</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-10"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb22"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb22-1" title="1"><span class="fl">6.</span> 1U &lt;&lt; <span class="dv">0</span>?</a>
<a class="sourceLine" id="cb22-2" title="2">    (a) <span class="dv">1</span>   (b) <span class="dv">4</span>  (c) UINT_MAX  (d) <span class="dv">0</span>  (e) undefined</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-11"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb23"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb23-1" title="1"><span class="fl">6.</span> 1U &lt;&lt; <span class="dv">0</span>?</a>
<a class="sourceLine" id="cb23-2" title="2">    (a) <span class="dv">1</span>   (b) <span class="dv">4</span>  (c) UINT_MAX  (d) <span class="dv">0</span>  (e) undefined</a>
<a class="sourceLine" id="cb23-3" title="3"></a>
<a class="sourceLine" id="cb23-4" title="4">&gt;&gt; (a)</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-12"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb24"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb24-1" title="1"><span class="fl">7.</span> 1U &lt;&lt; <span class="dv">32</span>?</a>
<a class="sourceLine" id="cb24-2" title="2">    (a) <span class="dv">1</span>   (b) <span class="dv">4</span>  (c) UINT_MAX  (d) INT_MIN  (e) <span class="dv">0</span>  (f) undefined</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-13"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb25"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb25-1" title="1"><span class="fl">7.</span> 1U &lt;&lt; <span class="dv">32</span>?</a>
<a class="sourceLine" id="cb25-2" title="2">    (a) <span class="dv">1</span>   (b) <span class="dv">4</span>  (c) UINT_MAX  (d) INT_MIN  (e) <span class="dv">0</span>  (f) undefined</a>
<a class="sourceLine" id="cb25-3" title="3"></a>
<a class="sourceLine" id="cb25-4" title="4">&gt;&gt; (f) in C</a>
<a class="sourceLine" id="cb25-5" title="5">   </a>
<a class="sourceLine" id="cb25-6" title="6">   x86 (<span class="dv">32</span>-bit), 1U &lt;&lt; <span class="dv">32</span> == <span class="dv">1</span>!</a>
<a class="sourceLine" id="cb25-7" title="7">   shl edx,cl</a>
<a class="sourceLine" id="cb25-8" title="8"></a>
<a class="sourceLine" id="cb25-9" title="9">   Q. 1U &lt;&lt; <span class="dv">-1</span>?</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-14"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb26"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb26-1" title="1"><span class="fl">8.</span> -1L &lt;&lt; <span class="dv">2</span>?</a>
<a class="sourceLine" id="cb26-2" title="2">    (a) <span class="dv">0</span>   (b) <span class="dv">4</span>  (c) INT_MAX  (d) INT_MIN   (e) undefined</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-15"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb27"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb27-1" title="1"><span class="fl">8.</span> -1L &lt;&lt; <span class="dv">2</span>?</a>
<a class="sourceLine" id="cb27-2" title="2">    (a) <span class="dv">0</span>   (b) <span class="dv">4</span>  (c) INT_MAX  (d) INT_MIN   (e) undefined</a>
<a class="sourceLine" id="cb27-3" title="3">    </a>
<a class="sourceLine" id="cb27-4" title="4">&gt;&gt; (e) in C</a>
<a class="sourceLine" id="cb27-5" title="5"></a>
<a class="sourceLine" id="cb27-6" title="6">   shift operations on sign integers are undefined</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-16"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb28"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb28-1" title="1"><span class="fl">9.</span> INT_MAX + <span class="dv">1</span>?</a>
<a class="sourceLine" id="cb28-2" title="2">    (a) <span class="dv">0</span>   (b) <span class="dv">1</span>  (c) INT_MAX  (d) UINT_MAX  (e) undefined</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-17"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb29"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb29-1" title="1"><span class="fl">9.</span> INT_MAX + <span class="dv">1</span>?</a>
<a class="sourceLine" id="cb29-2" title="2">    (a) <span class="dv">0</span>   (b) <span class="dv">1</span>  (c) INT_MAX  (d) UINT_MAX  (e) undefined</a>
<a class="sourceLine" id="cb29-3" title="3"></a>
<a class="sourceLine" id="cb29-4" title="4">&gt;&gt; (e) in C</a>
<a class="sourceLine" id="cb29-5" title="5"></a>
<a class="sourceLine" id="cb29-6" title="6">   overflow in sign integers are undefined!</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-18"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb30"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb30-1" title="1"><span class="fl">10.</span> UINT_MAX + <span class="dv">1</span>?</a>
<a class="sourceLine" id="cb30-2" title="2">    (a) <span class="dv">0</span>   (b) <span class="dv">1</span>  (c) INT_MAX  (d) UINT_MAX  (e) undefined</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-19"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb31"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb31-1" title="1"><span class="fl">10.</span> UINT_MAX + <span class="dv">1</span>?</a>
<a class="sourceLine" id="cb31-2" title="2">    (a) <span class="dv">0</span>   (b) <span class="dv">1</span>  (c) INT_MAX  (d) UINT_MAX  (e) undefined</a>
<a class="sourceLine" id="cb31-3" title="3"></a>
<a class="sourceLine" id="cb31-4" title="4">&gt;&gt; (a)</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-20"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb32"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb32-1" title="1"><span class="fl">11.</span> -INT_MIN?</a>
<a class="sourceLine" id="cb32-2" title="2">    (a) <span class="dv">0</span>   (b) <span class="dv">1</span>  (c) INT_MAX  (d) UINT_MAX  (e) INT_MIN</a>
<a class="sourceLine" id="cb32-3" title="3">    (f) undefined</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-21"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb33"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb33-1" title="1"><span class="fl">11.</span> -INT_MIN?</a>
<a class="sourceLine" id="cb33-2" title="2">    (a) <span class="dv">0</span>   (b) <span class="dv">1</span>  (c) INT_MAX  (d) UINT_MAX  (e) INT_MIN</a>
<a class="sourceLine" id="cb33-3" title="3">    (f) undefined</a>
<a class="sourceLine" id="cb33-4" title="4"></a>
<a class="sourceLine" id="cb33-5" title="5">&gt;&gt; (f) in C but reuslts in (e)</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-22"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb34"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb34-1" title="1"><span class="fl">12.</span> -1L &gt; 1U? on x86_64 and x86</a>
<a class="sourceLine" id="cb34-2" title="2">    (a) (<span class="dv">0</span>, <span class="dv">0</span>)  (b) (<span class="dv">1</span>, <span class="dv">1</span>)  (c) (<span class="dv">0</span>, <span class="dv">1</span>)  (d) (<span class="dv">1</span>, <span class="dv">0</span>)  </a>
<a class="sourceLine" id="cb34-3" title="3">    (e) undefined</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-23"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb35"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb35-1" title="1"><span class="fl">12.</span> -1L &gt; 1U? on x86_64 and x86</a>
<a class="sourceLine" id="cb35-2" title="2">    (a) (<span class="dv">0</span>, <span class="dv">0</span>)  (b) (<span class="dv">1</span>, <span class="dv">1</span>)  (c) (<span class="dv">0</span>, <span class="dv">1</span>)  (d) (<span class="dv">1</span>, <span class="dv">0</span>)  </a>
<a class="sourceLine" id="cb35-3" title="3">    (e) undefined</a>
<a class="sourceLine" id="cb35-4" title="4">    </a>
<a class="sourceLine" id="cb35-5" title="5">&gt;&gt; (c)</a>
<a class="sourceLine" id="cb35-6" title="6"></a>
<a class="sourceLine" id="cb35-7" title="7">   x86_64: size(<span class="dt">long</span>) &gt; <span class="kw">sizeof</span>(<span class="dt">unsigned</span> <span class="dt">int</span>)</a>
<a class="sourceLine" id="cb35-8" title="8">     -&gt; (<span class="dt">long</span>)-1L &gt; (<span class="dt">long</span>)1U</a>
<a class="sourceLine" id="cb35-9" title="9">   x86: sizeo(<span class="dt">long</span>) == <span class="kw">sizeof</span>(<span class="dt">unsigned</span> <span class="dt">int</span>)</a>
<a class="sourceLine" id="cb35-10" title="10">     -&gt; (<span class="dt">unsigned</span> <span class="dt">int</span>)-1L &gt; (<span class="dt">unsigned</span> <span class="dt">int</span>) 1U</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-24"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb36"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb36-1" title="1">BONUS. is it possible that a / b &lt; <span class="dv">0</span> when a &lt; <span class="dv">0</span> and b &lt; <span class="dv">0</span>?</a></code></pre></div>
</div></section>
<section class="slide level1" id="cs101-int.-ovfl.-and-undefined-behavior-25"><div>
<h1>CS101: Int. Ovfl. and Undefined Behavior</h1>
<div class="sourceCode" id="cb37"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb37-1" title="1">BONUS. is it possible that a / b &lt; <span class="dv">0</span> when a &lt; <span class="dv">0</span> and b &lt; <span class="dv">0</span>?</a>
<a class="sourceLine" id="cb37-2" title="2"></a>
<a class="sourceLine" id="cb37-3" title="3"> a = INT_MIN &amp;&amp; b == <span class="dv">-1</span>!</a></code></pre></div>
</div></section>
<section class="slide level1" id="integer-related-vulnerabilities"><div>
<h1>Integer-related Vulnerabilities</h1>
<ol type="1">
<li>Precision (or widthness) overflows</li>
<li>Arithmetic overflows</li>
<li>Signedness bugs</li>
<li>Undefined behaviors (e.g., time bomb)</li>
</ol>
</div></section>
<section class="slide level1" id="precision-error-cve-2015-1593"><div>
<h1>1. Precision Error: CVE-2015-1593</h1>
<ul>
<li>Arithmetic operations b/w unsigned int and unsigned long</li>
<li>Reducing ASLR entropy by four in Linux (in x86_64)</li>
</ul>
<div class="sourceCode" id="cb38"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><a class="sourceLine" id="cb38-1" title="1"><span class="co">// @fs/binfmt_elf.c</span></a>
<a class="sourceLine" id="cb38-2" title="2"><span class="dt">static</span> <span class="dt">unsigned</span> <span class="dt">long</span> randomize_stack_top(<span class="dt">unsigned</span> <span class="dt">long</span> stack_top) {</a>
<a class="sourceLine" id="cb38-3" title="3">  <span class="dt">unsigned</span> <span class="dt">int</span> random_variable = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb38-4" title="4">  <span class="cf">if</span> ((current-&gt;flags &amp; PF_RANDOMIZE) &amp;&amp;</a>
<a class="sourceLine" id="cb38-5" title="5">      !(current-&gt;personality &amp; ADDR_NO_RANDOMIZE)) {</a>
<a class="sourceLine" id="cb38-6" title="6">    random_variable = get_random_int() &amp; STACK_RND_MASK;</a>
<a class="sourceLine" id="cb38-7" title="7">*   random_variable &lt;&lt;= PAGE_SHIFT;</a>
<a class="sourceLine" id="cb38-8" title="8">  }</a>
<a class="sourceLine" id="cb38-9" title="9">  <span class="cf">return</span> PAGE_ALIGN(stack_top) - random_variable;</a>
<a class="sourceLine" id="cb38-10" title="10">}</a></code></pre></div>
</div></section>
<section class="slide level1" id="cve-2015-1593-patch"><div>
<h1>CVE-2015-1593: Patch</h1>
<ul>
<li>unsigned int → unsigned long (match the precision)</li>
<li>Be careful when you’d like to multiple architecture</li>
</ul>
<div class="sourceCode" id="cb39"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><a class="sourceLine" id="cb39-1" title="1"><span class="co">// @fs/binfmt_elf.c</span></a>
<a class="sourceLine" id="cb39-2" title="2"><span class="dt">static</span> <span class="dt">unsigned</span> <span class="dt">long</span> randomize_stack_top(<span class="dt">unsigned</span> <span class="dt">long</span> stack_top) {</a>
<a class="sourceLine" id="cb39-3" title="3">* <span class="dt">unsigned</span> <span class="dt">long</span> random_variable = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb39-4" title="4">  <span class="cf">if</span> ((current-&gt;flags &amp; PF_RANDOMIZE) &amp;&amp;</a>
<a class="sourceLine" id="cb39-5" title="5">      !(current-&gt;personality &amp; ADDR_NO_RANDOMIZE)) {</a>
<a class="sourceLine" id="cb39-6" title="6">    random_variable = get_random_int() &amp; STACK_RND_MASK;</a>
<a class="sourceLine" id="cb39-7" title="7">*   random_variable &lt;&lt;= PAGE_SHIFT;</a>
<a class="sourceLine" id="cb39-8" title="8">  }</a>
<a class="sourceLine" id="cb39-9" title="9">  <span class="cf">return</span> PAGE_ALIGN(stack_top) - random_variable;</a>
<a class="sourceLine" id="cb39-10" title="10">}</a></code></pre></div>
</div></section>
<section class="slide level1" id="arithmetic-overflow-cve-2018-6092"><div>
<h1>2. Arithmetic Overflow: CVE-2018-6092</h1>
<ul>
<li>Arithmetic overflows when adding two unsigned ints</li>
<li>Result in <em>remote</em> code execution in Chrome (V8/WASM, 32-bit)</li>
</ul>
<div class="sourceCode" id="cb40"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><a class="sourceLine" id="cb40-1" title="1"><span class="co">// @src/wasm/function-body-decoder-impl.h</span></a>
<a class="sourceLine" id="cb40-2" title="2"><span class="co">//  count: unsigned int</span></a>
<a class="sourceLine" id="cb40-3" title="3"><span class="co">//  type_list-&gt;size(): size_t</span></a>
<a class="sourceLine" id="cb40-4" title="4"><span class="co">//  kV8MaxWasmFunctionLocals: size_t</span></a>
<a class="sourceLine" id="cb40-5" title="5"></a>
<a class="sourceLine" id="cb40-6" title="6">* <span class="cf">if</span> ((count + type_list-&gt;size()) </a>
<a class="sourceLine" id="cb40-7" title="7">*       &gt; kV8MaxWasmFunctionLocals) {</a>
<a class="sourceLine" id="cb40-8" title="8">    decoder-&gt;error(decoder-&gt;pc()-<span class="dv">1</span>, <span class="st">"local count too large"</span>);</a>
<a class="sourceLine" id="cb40-9" title="9">    <span class="cf">return</span> false;</a>
<a class="sourceLine" id="cb40-10" title="10">  }</a></code></pre></div>
</div></section>
<section class="slide level1" id="cve-2018-6092-patch"><div>
<h1>CVE-2018-6092: Patch</h1>
<ul>
<li>Standard pattern/fix</li>
<li>Avoid potential arithmetic overflows</li>
</ul>
<div class="sourceCode" id="cb41"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><a class="sourceLine" id="cb41-1" title="1"><span class="co">// @src/wasm/function-body-decoder-impl.h</span></a>
<a class="sourceLine" id="cb41-2" title="2"><span class="co">//  count: unsigned int</span></a>
<a class="sourceLine" id="cb41-3" title="3"><span class="co">//  type_list-&gt;size(): size_t</span></a>
<a class="sourceLine" id="cb41-4" title="4"><span class="co">//  kV8MaxWasmFunctionLocals: size_t</span></a>
<a class="sourceLine" id="cb41-5" title="5"></a>
<a class="sourceLine" id="cb41-6" title="6">+ DCHECK_LE(type_list-&gt;size(), kV8MaxWasmFunctionLocals);</a>
<a class="sourceLine" id="cb41-7" title="7">+ <span class="cf">if</span> (count </a>
<a class="sourceLine" id="cb41-8" title="8">+      &gt; kV8MaxWasmFunctionLocals - type_list-&gt;size()) {</a>
<a class="sourceLine" id="cb41-9" title="9">    decoder-&gt;error(decoder-&gt;pc()-<span class="dv">1</span>, <span class="st">"local count too large"</span>);</a>
<a class="sourceLine" id="cb41-10" title="10">    <span class="cf">return</span> false;</a>
<a class="sourceLine" id="cb41-11" title="11">  }</a></code></pre></div>
</div></section>
<section class="slide level1" id="signedness-bugs-cve-2017-7308"><div>
<h1>3. Signedness Bugs: CVE-2017-7308</h1>
<ul>
<li>Casting the arithmetic result of unsigned ints to sign for comparison</li>
<li>Result in <em>remote</em> code execution in Linux (network stack)</li>
</ul>
<div class="sourceCode" id="cb42"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><a class="sourceLine" id="cb42-1" title="1"><span class="co">// @net/packet/af_packet.c</span></a>
<a class="sourceLine" id="cb42-2" title="2"><span class="co">//   req-&gt;tp_block_size: unsigned int</span></a>
<a class="sourceLine" id="cb42-3" title="3"><span class="co">//   BLK_PLUS_PRIV(..) : unsigned int</span></a>
<a class="sourceLine" id="cb42-4" title="4"></a>
<a class="sourceLine" id="cb42-5" title="5"><span class="co">// Q. What if we don't have (int)?</span></a>
<a class="sourceLine" id="cb42-6" title="6"><span class="cf">if</span> (po-&gt;tp_version &gt;= TPACKET_V3 &amp;&amp;</a>
<a class="sourceLine" id="cb42-7" title="7">*   (<span class="dt">int</span>)(req-&gt;tp_block_size -</a>
<a class="sourceLine" id="cb42-8" title="8">*         BLK_PLUS_PRIV(req_u-&gt;req3.tp_sizeof_priv)) &lt;= <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb42-9" title="9">    <span class="cf">goto</span> out;</a></code></pre></div>
</div></section>
<section class="slide level1" id="cve-2017-7308-patch"><div>
<h1>CVE-2017-7308: Patch</h1>
<ul>
<li>Direct comparison of unsigned ints!</li>
<li>Fix a potential overflow inside the macro as well</li>
</ul>
<div class="sourceCode" id="cb43"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><a class="sourceLine" id="cb43-1" title="1"><span class="co">// @net/packet/af_packet.c</span></a>
<a class="sourceLine" id="cb43-2" title="2"><span class="co">//   req-&gt;tp_block_size: unsigned int</span></a>
<a class="sourceLine" id="cb43-3" title="3"><span class="co">//   BLK_PLUS_PRIV(..) : unsigned long long</span></a>
<a class="sourceLine" id="cb43-4" title="4"></a>
<a class="sourceLine" id="cb43-5" title="5"><span class="cf">if</span> (po-&gt;tp_version &gt;= TPACKET_V3 &amp;&amp;</a>
<a class="sourceLine" id="cb43-6" title="6">*   req-&gt;tp_block_size </a>
<a class="sourceLine" id="cb43-7" title="7">*     &lt;= BLK_PLUS_PRIV((u64)req_u-&gt;req3.tp_sizeof_priv))</a>
<a class="sourceLine" id="cb43-8" title="8">    <span class="cf">goto</span> out;</a></code></pre></div>
</div></section>
<section class="slide level1" id="testing-signedness-bugs"><div>
<h1>Testing Signedness Bugs</h1>
<div class="sourceCode" id="cb44"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb44-1" title="1">  $ cd lec03-intovfl/intovfl</a>
<a class="sourceLine" id="cb44-2" title="2">  $ make</a>
<a class="sourceLine" id="cb44-3" title="3"></a>
<a class="sourceLine" id="cb44-4" title="4">  $ ./uintcmp</a>
<a class="sourceLine" id="cb44-5" title="5">  <span class="dv">0</span> &lt; <span class="dv">1</span> = <span class="dv">1</span>?</a>
<a class="sourceLine" id="cb44-6" title="6">    (<span class="dt">int</span>)(<span class="dv">0</span> - <span class="dv">1</span>) == <span class="dv">-1</span> &lt;= <span class="dv">0</span>? -&gt; <span class="dv">1</span></a>
<a class="sourceLine" id="cb44-7" title="7">  <span class="dv">1</span> &lt; <span class="dv">0</span> = <span class="dv">0</span>?</a>
<a class="sourceLine" id="cb44-8" title="8">    (<span class="dt">int</span>)(<span class="dv">1</span> - <span class="dv">0</span>) ==  <span class="dv">1</span> &lt;= <span class="dv">0</span>? -&gt; <span class="dv">0</span></a>
<a class="sourceLine" id="cb44-9" title="9">  <span class="dv">4294967196</span> &lt; <span class="dv">200</span> = <span class="dv">1</span>?</a>
<a class="sourceLine" id="cb44-10" title="10">    (<span class="dt">int</span>)(<span class="dv">4294967196</span> - <span class="dv">200</span>) == <span class="dv">-300</span> &lt;= <span class="dv">0</span>? -&gt; <span class="dv">1</span></a>
<a class="sourceLine" id="cb44-11" title="11">  <span class="dt">unsigned</span> <span class="dt">int</span> a = ?</a>
<a class="sourceLine" id="cb44-12" title="12">  <span class="dt">unsigned</span> <span class="dt">int</span> b = ?</a></code></pre></div>
</div></section>
<section class="slide level1" id="undefined-behaviors-naclx86"><div>
<h1>4. Undefined Behaviors: NaCL/x86</h1>
<ul>
<li>Shifting more than the available #bits</li>
<li>Result in the entire sandbox sequence no-op!</li>
</ul>
<div class="sourceCode" id="cb45"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb45-1" title="1"><span class="co">// @NaClSandboxAddr()</span></a>
<a class="sourceLine" id="cb45-2" title="2">                                 +--&gt; <span class="dv">32</span> bytes in x32</a>
<a class="sourceLine" id="cb45-3" title="3">                                 |</a>
<a class="sourceLine" id="cb45-4" title="4">                                 +------------------</a>
<a class="sourceLine" id="cb45-5" title="5"><span class="cf">return</span> addr &amp; ~(<span class="dt">uintptr_t</span>)((<span class="dv">1</span> &lt;&lt; nap-&gt;align_boundary) - <span class="dv">1</span>);</a>
<a class="sourceLine" id="cb45-6" title="6">                           +-------------------------</a>
<a class="sourceLine" id="cb45-7" title="7">                           |</a>
<a class="sourceLine" id="cb45-8" title="8">                           +--&gt; (<span class="dv">1</span> &lt;&lt; <span class="dv">32</span>) -&gt; <span class="dv">1</span> in gcc!</a></code></pre></div>
<p>Ref. <a class="uri" href="https://bugs.chromium.org/p/nativeclient/issues/detail?id=245">https://bugs.chromium.org/p/nativeclient/issues/detail?id=245</a></p>
</div></section>
<section class="slide level1" id="secure-way-to-add-two-ints"><div>
<h1>Secure Way to Add Two Ints</h1>
<ul>
<li><a href="https://wiki.sei.cmu.edu/confluence/display/c/INT32-C.+Ensure+that+operations+on+signed+integers+do+not+result+in+overflow">SEI CERT C Coding Standard</a></li>
</ul>
<div class="sourceCode" id="cb46"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb46-1" title="1"><span class="dt">void</span> func(<span class="dt">signed</span> <span class="dt">int</span> si_a, <span class="dt">signed</span> <span class="dt">int</span> si_b) {</a>
<a class="sourceLine" id="cb46-2" title="2">  <span class="dt">signed</span> <span class="dt">int</span> sum = si_a + si_b;</a>
<a class="sourceLine" id="cb46-3" title="3">  <span class="co">/* ... */</span></a>
<a class="sourceLine" id="cb46-4" title="4">}</a></code></pre></div>
</div></section>
<section class="slide level1" id="secure-way-to-add-two-ints-1"><div>
<h1>Secure Way to Add Two Ints</h1>
<div class="sourceCode" id="cb47"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><a class="sourceLine" id="cb47-1" title="1"><span class="pp">#include </span><span class="im">&lt;limits.h&gt;</span></a>
<a class="sourceLine" id="cb47-2" title="2">  </a>
<a class="sourceLine" id="cb47-3" title="3"><span class="dt">void</span> f(<span class="dt">signed</span> <span class="dt">int</span> si_a, <span class="dt">signed</span> <span class="dt">int</span> si_b) {</a>
<a class="sourceLine" id="cb47-4" title="4">  <span class="dt">signed</span> <span class="dt">int</span> sum;</a>
<a class="sourceLine" id="cb47-5" title="5">  <span class="cf">if</span> (((si_b &gt; <span class="dv">0</span>) &amp;&amp; (si_a &gt; (INT_MAX - si_b))) ||</a>
<a class="sourceLine" id="cb47-6" title="6">      ((si_b &lt; <span class="dv">0</span>) &amp;&amp; (si_a &lt; (INT_MIN - si_b)))) {</a>
<a class="sourceLine" id="cb47-7" title="7">    <span class="co">/* Handle error */</span></a>
<a class="sourceLine" id="cb47-8" title="8">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb47-9" title="9">    sum = si_a + si_b;</a>
<a class="sourceLine" id="cb47-10" title="10">  }</a>
<a class="sourceLine" id="cb47-11" title="11">  <span class="co">/* ... */</span></a>
<a class="sourceLine" id="cb47-12" title="12">}</a></code></pre></div>
</div></section>
<section class="slide level1" id="secure-way-to-multiplying-two-ints"><div>
<h1>Secure Way to Multiplying Two Ints</h1>
<div class="sourceCode" id="cb48"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb48-1" title="1"><span class="dt">void</span> func(<span class="dt">signed</span> <span class="dt">int</span> si_a, <span class="dt">signed</span> <span class="dt">int</span> si_b) {</a>
<a class="sourceLine" id="cb48-2" title="2">  <span class="dt">signed</span> <span class="dt">int</span> result = si_a * si_b;</a>
<a class="sourceLine" id="cb48-3" title="3">  <span class="co">/* ... */</span></a>
<a class="sourceLine" id="cb48-4" title="4">}</a></code></pre></div>
</div></section>
<section class="slide level1" id="secure-way-to-multiplying-two-ints-1"><div>
<h1>Secure Way to Multiplying Two Ints</h1>
<div class="sourceCode" id="cb49"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><a class="sourceLine" id="cb49-1" title="1"><span class="dt">void</span> func(<span class="dt">signed</span> <span class="dt">int</span> si_a, <span class="dt">signed</span> <span class="dt">int</span> si_b) {</a>
<a class="sourceLine" id="cb49-2" title="2">  <span class="dt">signed</span> <span class="dt">int</span> result;</a>
<a class="sourceLine" id="cb49-3" title="3">  <span class="dt">signed</span> <span class="dt">long</span> <span class="dt">long</span> tmp;</a>
<a class="sourceLine" id="cb49-4" title="4"></a>
<a class="sourceLine" id="cb49-5" title="5">  tmp = (<span class="dt">signed</span> <span class="dt">long</span> <span class="dt">long</span>)si_a * (<span class="dt">signed</span> <span class="dt">long</span> <span class="dt">long</span>)si_b;</a>
<a class="sourceLine" id="cb49-6" title="6">  </a>
<a class="sourceLine" id="cb49-7" title="7">  <span class="co">/* If the product cannot be represented as a 32-bit integer,</span></a>
<a class="sourceLine" id="cb49-8" title="8"><span class="co">     handle as an error condition. */</span></a>
<a class="sourceLine" id="cb49-9" title="9">  <span class="cf">if</span> ((tmp &gt; INT_MAX) || (tmp &lt; INT_MIN)) {</a>
<a class="sourceLine" id="cb49-10" title="10">    <span class="co">/* Handle error */</span></a>
<a class="sourceLine" id="cb49-11" title="11">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb49-12" title="12">    result = (<span class="dt">int</span>)tmp;</a>
<a class="sourceLine" id="cb49-13" title="13">  }</a>
<a class="sourceLine" id="cb49-14" title="14">  <span class="co">/* ... */</span></a>
<a class="sourceLine" id="cb49-15" title="15">}</a></code></pre></div>
</div></section>
<section class="slide level1" id="secure-way-to-multiplying-two-ints-2"><div>
<h1>Secure Way to Multiplying Two Ints</h1>
<p style="text-align:center;margin:0"><img src="img/mult.png" style="width:60%"/></p>
</div></section>
<section class="slide level1" id="case-study-chackra-core-multiplying-ints"><div>
<h1>Case Study: Chackra Core (Multiplying Ints)</h1>
<div class="sourceCode" id="cb50"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><a class="sourceLine" id="cb50-1" title="1"><span class="co">// Returns true if we overflowed, false if we didn't</span></a>
<a class="sourceLine" id="cb50-2" title="2"><span class="dt">bool</span> Int64Math::Mul(int64 left, int64 right, int64 *pResult) {</a>
<a class="sourceLine" id="cb50-3" title="3"><span class="pp">#if defined(_M_X64) </span></a>
<a class="sourceLine" id="cb50-4" title="4">  <span class="co">// (I)MUL (Q/64) R[D/A]X &lt;- RAX * r/m64</span></a>
<a class="sourceLine" id="cb50-5" title="5">  int64 high;</a>
<a class="sourceLine" id="cb50-6" title="6">  *pResult = _mul128(left, right, &amp;high);</a>
<a class="sourceLine" id="cb50-7" title="7">  <span class="cf">return</span> ((*pResult &gt; <span class="dv">0</span>) &amp;&amp; high != <span class="dv">0</span>) \</a>
<a class="sourceLine" id="cb50-8" title="8">           || ((*pResult &lt; <span class="dv">0</span>) &amp;&amp; (high != <span class="dv">-1</span>));</a>
<a class="sourceLine" id="cb50-9" title="9"><span class="pp">#else</span></a>
<a class="sourceLine" id="cb50-10" title="10">  *pResult = left * right;</a>
<a class="sourceLine" id="cb50-11" title="11">  <span class="cf">return</span> (left != <span class="dv">0</span> &amp;&amp; right != <span class="dv">0</span> \</a>
<a class="sourceLine" id="cb50-12" title="12">           &amp;&amp; (*pResult / left) != right);</a>
<a class="sourceLine" id="cb50-13" title="13"><span class="pp">#endif</span></a>
<a class="sourceLine" id="cb50-14" title="14">}</a></code></pre></div>
</div></section>
<section class="slide level1" id="case-study-glibc-multiplying-uints"><div>
<h1>Case Study: glibc (Multiplying UInts)</h1>
<div class="sourceCode" id="cb51"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><a class="sourceLine" id="cb51-1" title="1"><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">bool</span></a>
<a class="sourceLine" id="cb51-2" title="2">check_mul_overflow_size_t(<span class="dt">size_t</span> left, <span class="dt">size_t</span> right, </a>
<a class="sourceLine" id="cb51-3" title="3">                          <span class="dt">size_t</span> *result) {</a>
<a class="sourceLine" id="cb51-4" title="4">  <span class="co">/* size_t is unsigned </span></a>
<a class="sourceLine" id="cb51-5" title="5"><span class="co">     so the behavior on overflow is defined. */</span></a>
<a class="sourceLine" id="cb51-6" title="6">  *result = left * right;</a>
<a class="sourceLine" id="cb51-7" title="7">  <span class="dt">size_t</span> half_size_t \</a>
<a class="sourceLine" id="cb51-8" title="8">    = ((<span class="dt">size_t</span>) <span class="dv">1</span>) &lt;&lt; (<span class="dv">8</span> * <span class="kw">sizeof</span> (<span class="dt">size_t</span>) / <span class="dv">2</span>);</a>
<a class="sourceLine" id="cb51-9" title="9"></a>
<a class="sourceLine" id="cb51-10" title="10">  <span class="cf">if</span> ((left | right) &gt;= half_size_t) {</a>
<a class="sourceLine" id="cb51-11" title="11">    <span class="cf">if</span> (right != <span class="dv">0</span> &amp;&amp; *result / right != left)</a>
<a class="sourceLine" id="cb51-12" title="12">      <span class="cf">return</span> true;</a>
<a class="sourceLine" id="cb51-13" title="13">  }</a>
<a class="sourceLine" id="cb51-14" title="14">  <span class="cf">return</span> false;</a>
<a class="sourceLine" id="cb51-15" title="15">}</a></code></pre></div>
</div></section>
<section class="slide level1" id="new-proposals-__builtin__overflow"><div>
<h1>New Proposals: __builtin_*_overflow()</h1>
<ul>
<li>Ref. <a class="uri" href="https://gcc.gnu.org/onlinedocs/gcc/Integer-Overflow-Builtins.html">https://gcc.gnu.org/onlinedocs/gcc/Integer-Overflow-Builtins.html</a></li>
</ul>
<div class="sourceCode" id="cb52"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb52-1" title="1"><span class="dt">bool</span> __builtin_add_overflow (type1 a, type2 b, type3 *res);</a>
<a class="sourceLine" id="cb52-2" title="2"><span class="dt">bool</span> __builtin_sub_overflow (type1 a, type2 b, type3 *res);</a>
<a class="sourceLine" id="cb52-3" title="3"><span class="dt">bool</span> __builtin_mul_overflow (type1 a, type2 b, type3 *res);</a>
<a class="sourceLine" id="cb52-4" title="4"></a>
<a class="sourceLine" id="cb52-5" title="5"><span class="dt">bool</span> __builtin_uadd_overflow (<span class="dt">unsigned</span> <span class="dt">int</span> a, <span class="dt">unsigned</span> <span class="dt">int</span> b,</a>
<a class="sourceLine" id="cb52-6" title="6">                              <span class="dt">unsigned</span> <span class="dt">int</span> *res);</a>
<a class="sourceLine" id="cb52-7" title="7">...</a></code></pre></div>
</div></section>
<section class="slide level1" id="taking-advantage-of-erflags-in-x86"><div>
<h1>Taking Advantage of E/RFLAGS in x86</h1>
<div class="sourceCode" id="cb53"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb53-1" title="1">    <span class="dt">bool</span> __builtin_add_overflow (type1 a, type2 b, type3 *res);</a>
<a class="sourceLine" id="cb53-2" title="2"></a>
<a class="sourceLine" id="cb53-3" title="3">    11bb:   mov    ecx,<span class="bn">0x0</span></a>
<a class="sourceLine" id="cb53-4" title="4">    11c0:   add    eax,edx</a>
<a class="sourceLine" id="cb53-5" title="5">    11c2:   jno    11c9 &lt;main+<span class="bn">0x70</span>&gt;</a>
<a class="sourceLine" id="cb53-6" title="6">    11c4:   mov    ecx,<span class="bn">0x1</span></a>
<a class="sourceLine" id="cb53-7" title="7">    llc9:   ...</a></code></pre></div>
</div></section>
<section class="slide level1" id="example-new-calloc"><div>
<h1>Example: New calloc()</h1>
<div class="sourceCode" id="cb54"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><a class="sourceLine" id="cb54-1" title="1"><span class="dt">void</span> * calloc (<span class="dt">size_t</span> x, <span class="dt">size_t</span> y) {</a>
<a class="sourceLine" id="cb54-2" title="2">  <span class="dt">size_t</span> sz;</a>
<a class="sourceLine" id="cb54-3" title="3">  <span class="cf">if</span> (__builtin_mul_overflow (x, y, &amp;sz))</a>
<a class="sourceLine" id="cb54-4" title="4">    <span class="cf">return</span> NULL;</a>
<a class="sourceLine" id="cb54-5" title="5">  <span class="dt">void</span> *ret = malloc (sz);</a>
<a class="sourceLine" id="cb54-6" title="6">  <span class="cf">if</span> (ret)</a>
<a class="sourceLine" id="cb54-7" title="7">    memset (ret, <span class="dv">0</span>, sz);</a>
<a class="sourceLine" id="cb54-8" title="8">  <span class="cf">return</span> ret;</a>
<a class="sourceLine" id="cb54-9" title="9">}</a></code></pre></div>
</div></section>
<section class="slide level1" id="integer-overflow-beyond-security"><div>
<h1>Integer Overflow Beyond Security</h1>
<ul>
<li>1996: Ariane 5 rocket crashed</li>
<li>2015: FAA requested to reset Boeing 787 every 248 days</li>
<li>2016: a Casino machine printed a prize ticket of $42,949,672!</li>
</ul>
<p>Ref. <a class="uri" href="https://en.wikipedia.org/wiki/Integer_overflow">https://en.wikipedia.org/wiki/Integer_overflow</a></p>
</div></section>
<section class="slide level1" id="not-abusing-int-related-bu-in-optimizer"><div>
<h1>Not Abusing Int-related BU in Optimizer</h1>
<ul>
<li>Option: -fwrapv (gcc/clang)</li>
</ul>
<div class="sourceCode" id="cb55"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><a class="sourceLine" id="cb55-1" title="1">  <span class="co">// $ cd lec03-intovfl/intovfl</span></a>
<a class="sourceLine" id="cb55-2" title="2">  <span class="co">// $ make check-fwrapv</span></a>
<a class="sourceLine" id="cb55-3" title="3"></a>
<a class="sourceLine" id="cb55-4" title="4">  <span class="dt">int</span> base;</a>
<a class="sourceLine" id="cb55-5" title="5">  scanf(<span class="st">"%d"</span>, &amp;base);</a>
<a class="sourceLine" id="cb55-6" title="6"></a>
<a class="sourceLine" id="cb55-7" title="7">  <span class="co">// Q. base = INT_MAX?</span></a>
<a class="sourceLine" id="cb55-8" title="8">  <span class="cf">if</span> (base &lt; base + <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb55-9" title="9">    printf(<span class="st">"base &lt; base + 1 is true!</span><span class="sc">\n</span><span class="st">"</span>);</a></code></pre></div>
</div></section>
<section class="slide level1" id="exercise-real-world-examples"><div>
<h1>Exercise: Real-world Examples</h1>
<ul>
<li>Ex1. Android Stagefright (CVE-2015-1538, CVE-2015-3824)</li>
<li>Ex2. Linux Keyring (CVE-2016-0728)</li>
</ul>
</div></section>
<section class="slide level1" id="exercise-real-world-examples-1"><div>
<h1>Exercise: Real-world Examples</h1>
<ul>
<li>Ex1. Android Stagefright (CVE-2015-1538, CVE-2015-3824)
<ul>
<li>→ Remote exploit on Android via MMS</li>
</ul></li>
<li>Ex2. Linux Keyring (CVE-2016-0728)
<ul>
<li>→ Local privilege escalation</li>
</ul></li>
</ul>
</div></section>
<section class="slide level1" id="cve-2015-1538-android-stagefright"><div>
<h1>CVE-2015-1538: Android (Stagefright)</h1>
<ul>
<li>Result in out-of-bound writes after integer overflows</li>
</ul>
<div class="sourceCode" id="cb56"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><a class="sourceLine" id="cb56-1" title="1"><span class="co">// @edd4a76eb4747bd19ed122df46fa46b452c12a0d</span></a>
<a class="sourceLine" id="cb56-2" title="2"><span class="co">// CVE-2015-1538</span></a>
<a class="sourceLine" id="cb56-3" title="3"><span class="co">//   uint32_t mTimeToSampleCount;</span></a>
<a class="sourceLine" id="cb56-4" title="4"></a>
<a class="sourceLine" id="cb56-5" title="5">     mTimeToSampleCount = U32_AT(&amp;header[<span class="dv">4</span>]);</a>
<a class="sourceLine" id="cb56-6" title="6">     mTimeToSample = new <span class="dt">uint32_t</span>[mTimeToSampleCount * <span class="dv">2</span>];</a>
<a class="sourceLine" id="cb56-7" title="7">     ...</a>
<a class="sourceLine" id="cb56-8" title="8">     <span class="cf">for</span> (<span class="dt">uint32_t</span> i = <span class="dv">0</span>; i &lt; mTimeToSampleCount * <span class="dv">2</span>; ++i)</a>
<a class="sourceLine" id="cb56-9" title="9">        mTimeToSample[i] = ntohl(mTimeToSample[i]);</a>
<a class="sourceLine" id="cb56-10" title="10">     ...</a></code></pre></div>
</div></section>
<section class="slide level1" id="cve-2015-1538-android-stagefright-1"><div>
<h1>CVE-2015-1538: Android (Stagefright)</h1>
<div class="sourceCode" id="cb57"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><a class="sourceLine" id="cb57-1" title="1"><span class="co">// @edd4a76eb4747bd19ed122df46fa46b452c12a0d</span></a>
<a class="sourceLine" id="cb57-2" title="2"><span class="co">// CVE-2015-1538</span></a>
<a class="sourceLine" id="cb57-3" title="3">     mTimeToSampleCount = U32_AT(&amp;header[<span class="dv">4</span>]);</a>
<a class="sourceLine" id="cb57-4" title="4">+    <span class="dt">uint64_t</span> allocSize \</a>
<a class="sourceLine" id="cb57-5" title="5">+               = mTimeToSampleCount * <span class="dv">2</span> * <span class="kw">sizeof</span>(<span class="dt">uint32_t</span>);</a>
<a class="sourceLine" id="cb57-6" title="6">+    <span class="cf">if</span> (allocSize &gt; SIZE_MAX) {</a>
<a class="sourceLine" id="cb57-7" title="7">+      <span class="cf">return</span> ERROR_OUT_OF_RANGE;</a>
<a class="sourceLine" id="cb57-8" title="8">+    }</a>
<a class="sourceLine" id="cb57-9" title="9">     mTimeToSample = new <span class="dt">uint32_t</span>[mTimeToSampleCount * <span class="dv">2</span>];</a>
<a class="sourceLine" id="cb57-10" title="10">     ...</a></code></pre></div>
</div></section>
<section class="slide level1" id="cve-2015-3824-android-stagefright"><div>
<h1>CVE-2015-3824: Android (Stagefright)</h1>
<div class="sourceCode" id="cb58"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><a class="sourceLine" id="cb58-1" title="1"><span class="co">// @463a6f807e187828442949d1924e143cf07778c6</span></a>
<a class="sourceLine" id="cb58-2" title="2"><span class="co">// CVE-2015-3824</span></a>
<a class="sourceLine" id="cb58-3" title="3">-    <span class="dt">uint8_t</span> *buffer = new <span class="dt">uint8_t</span>[size + chunk_size];</a>
<a class="sourceLine" id="cb58-4" title="4">+    <span class="cf">if</span> (SIZE_MAX - chunk_size &lt;= size) {</a>
<a class="sourceLine" id="cb58-5" title="5">+      <span class="cf">return</span> ERROR_MALFORMED;</a>
<a class="sourceLine" id="cb58-6" title="6">+    }</a>
<a class="sourceLine" id="cb58-7" title="7">+</a>
<a class="sourceLine" id="cb58-8" title="8">+    <span class="dt">uint8_t</span> *buffer = new <span class="dt">uint8_t</span>[size + chunk_size];</a></code></pre></div>
</div></section>
<section class="slide level1" id="cve-2016-0728-linux-keyring"><div>
<h1>CVE-2016-0728: Linux Keyring</h1>
<ul>
<li>Forcing the refcnt to be overflowed, resulting in privlege escalation!</li>
</ul>
<div class="sourceCode" id="cb59"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><a class="sourceLine" id="cb59-1" title="1"><span class="dt">long</span> join_session_keyring(<span class="dt">const</span> <span class="dt">char</span> *name) {</a>
<a class="sourceLine" id="cb59-2" title="2">  <span class="co">// </span><span class="al">NOTE</span><span class="co">. refcnt is incremented on "success"!</span></a>
<a class="sourceLine" id="cb59-3" title="3">  keyring = find_keyring_by_name(name, false); </a>
<a class="sourceLine" id="cb59-4" title="4">  <span class="cf">if</span> (PTR_ERR(keyring) == -ENOKEY) { ... } </a>
<a class="sourceLine" id="cb59-5" title="5">  <span class="cf">else</span> <span class="cf">if</span> (IS_ERR(keyring)) { ... }</a>
<a class="sourceLine" id="cb59-6" title="6">  } <span class="cf">else</span> <span class="cf">if</span> (keyring == new-&gt;session_keyring) {</a>
<a class="sourceLine" id="cb59-7" title="7">    ret = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb59-8" title="8">    <span class="cf">goto</span> error2;</a>
<a class="sourceLine" id="cb59-9" title="9">  }</a>
<a class="sourceLine" id="cb59-10" title="10">  ...</a>
<a class="sourceLine" id="cb59-11" title="11">  key_put(keyring);</a>
<a class="sourceLine" id="cb59-12" title="12"> error2:</a>
<a class="sourceLine" id="cb59-13" title="13">  <span class="cf">return</span> ret;</a>
<a class="sourceLine" id="cb59-14" title="14">}</a></code></pre></div>
</div></section>
<section class="slide level1" id="summary"><div>
<h1>Summary</h1>
<ul>
<li>Two classes of vulnerabilities:
<ol type="1">
<li>Integer overflow</li>
<li>Undefined behavior</li>
</ol></li>
<li>They are likely to have serious security implications when happened!</li>
<li>Common patterns and known ways to mitigate/elliminate them!</li>
</ul>
</div></section>
<section class="slide level1" id="references"><div>
<h1>References</h1>
<ul>
<li><a href="https://www.blackhat.com/docs/us-15/materials/us-15-Drake-Stagefright-Scary-Code-In-The-Heart-Of-Android.pdf">Stagefright Bugs</a></li>
<li><a href="http://phrack.org/issues/60/10.html">Basic Integer Overflows</a></li>
<li><a href="https://wiki.sei.cmu.edu/confluence/display/c/INT02-C.+Understand+integer+conversion+rules">Integer Rules</a></li>
<li><a href="https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html">CVE-2017-7308</a></li>
<li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=819869">CVE-2018-6092</a></li>
<li><a href="http://hmarco.org/bugs/linux-ASLR-integer-overflow.html">CVE-2015-1593</a></li>
</ul>
</div></section>
<div class="progress"><div></div></div>
<script src="../shower/js/shower.js"></script>
</body>
</html>